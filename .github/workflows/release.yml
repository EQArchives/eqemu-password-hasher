name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: amd64
          - os: macos-latest
            platform: darwin
            arch: universal
          - os: windows-latest
            platform: windows
            arch: amd64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev

    - name: Install fyne CLI
      run: go install fyne.io/fyne/v2/cmd/fyne@latest

    - name: Package app
      run: fyne package -os ${{ matrix.platform }} -icon Icon.png

    - name: Sign macOS app (ad-hoc)
      if: runner.os == 'macOS'
      run: |
        APP_NAME=$(ls -d *.app | head -n 1)
        if [ -n "$APP_NAME" ]; then
          # Remove existing signature
          codesign --remove-signature "$APP_NAME"
          # Sign with ad-hoc signature
          codesign --force --deep --sign - "$APP_NAME"
          # Verify it worked
          codesign --verify --verbose "$APP_NAME"
        fi

    - name: Prepare Windows artifact
      if: runner.os == 'Windows'
      run: |
        $files = Get-ChildItem -Filter "*.exe"
        if ($files.Count -gt 0) {
          Move-Item $files[0].Name "EQEmu-Password-Hasher-Windows.exe"
        }

    - name: Prepare macOS artifact
      if: runner.os == 'macOS'
      run: |
        APP_NAME=$(ls -d *.app | head -n 1)
        if [ -n "$APP_NAME" ]; then
          zip -r "EQEmu-Password-Hasher-macOS.zip" "$APP_NAME"
        fi

    - name: Prepare Linux artifact
      if: runner.os == 'Linux'
      run: |
        TAR_FILE=$(ls *.tar.xz | head -n 1)
        if [ -n "$TAR_FILE" ]; then
          mv "$TAR_FILE" "EQEmu-Password-Hasher-Linux.tar.xz"
        fi

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        files: |
          EQEmu-Password-Hasher-Windows.exe
          EQEmu-Password-Hasher-macOS.zip
          EQEmu-Password-Hasher-Linux.tar.xz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
